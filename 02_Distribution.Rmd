---
title: "MoGCN"
subtitle: "April 24th, 2023"
author: "Ryohei SHIBATA"
output:
  powerpoint_presentation:
    slide_level: 2 # use this to override default
    reference_doc: ~/Git/R/Template_ENW.pptx
---

```{R, include = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      eval = FALSE, 
                      warning = FALSE, 
                      message = FALSE, 
                      comment = "",
                      cache = FALSE) 

source("Setup.R")
```

# Preparation
```{R}
Clinicaldata_tbw %>%
  filter(study_id %in% study_id_Analysis) %>%
  select(study_id,
         Age_mo, intch_weight, intake_sex, premature37,
         RV, RSV, RVC_NPAseq, hMPV,
         tige, atopy_ISAC_food19, # atopy_ISAC_any
         parent_asthma, parent_eczema,
         # intake_rsvshot, mo30_dog_0to1, # too many NA
         corticosteroids_life, prev_breathingprob) -> Clinicaldata_NN_tbw

Clinicaldata_NN_tbw %>% 
  mutate(RVC_NPAseq = if_else(is.na(RVC_NPAseq), 0, 1)) %>%
  mutate(prev_breathingprob = if_else(prev_breathingprob == "0", 0, 1)) %>% 
  mutate(intake_sex = if_else(intake_sex == "Male", 1, 0)) %>% 
  mutate_if(is.factor, as.character) %>% 
  mutate_if(is.character, as.numeric) %>% 
  gather(Variable, Value, -study_id) %>%
  mutate(Value = as.numeric(as.character(Value))) %>%
  mutate(study_id = as.factor(study_id)) %>% 
  c2f -> Clinical_tbl
```


```{R}
list(mRNA = # mRNA_RA_RAW_tbl %>% 
       mRNA_VST_RAW_tbl %>% 
            rename(Variable = Ensembl) %>% 
       filter(study_id %in% study_id_Analysis),
     
     Lipid = Lipid_Species_tbl %>% 
       filter(study_id %in% study_id_Analysis) %>%
       ungroup %>% 
     #   spread(Variable, Value) %>%
     # c2r("study_id") %>%
     # IMIFA::pareto_scale(.,
     #                  centering = FALSE) %>%
     #   r2c("study_id") %>%
     #   gather(Variable, Value, -study_id) %>%
       c2f,
     Clinical = Clinical_tbl %>%
       filter(study_id %in% study_id_Analysis) %>% 
  # filter(Variable %in% Variable_Con)  %>% 
  # bind_rows(Clinical_tbl %>% 
  #             filter(!Variable %in% Variable_Con) %>% 
  #             mutate(Value = if_else(Value == 0, -1, Value))) %>% 
    c2f
  ) -> Data_tbl_list
```

# Lipid
## MAD0 distribution
```{R}
Data_tbl_list %>% 
  map(., function(tbl){
    tbl %>% 
    remove_all0 %>% 
    remove_mad0  %>% 
    .$Variable  -> nonmad0
  
  tbl %>% 
  remove_all0 %>% 
  ungroup %>% 
  filter(!Variable %in% nonmad0)}) -> Data_MAD0_tbl_list

map(Data_MAD0_tbl_list,
    ~ check_levels(.x, "Variable")) -> Data_MAD0

Data_MAD0[["mRNA"]] %>% 
  sample(., 100) -> mRNA_MAD0_100

Data_MAD0_tbl_list[["mRNA"]]  %>% 
  filter(Variable %in% mRNA_MAD0_100) %>% 
  ggplot(.,
       aes(x = Value, y = ..scaled.., fill = Variable))+
  geom_density(alpha = 0.3)+
  guides(fill = FALSE)
ggsave("Distribution/Density_mRNA_MAD0.png",
       dpi = 300, h = 3, w = 3.5)
```
![Keep MAD0, just remove all0.](Distribution/Density_mRNA_MAD0.png)

## IQR0 distribution
```{R}
Data_tbl_list %>% 
  map(., function(tbl){
    tbl %>% 
    remove_all0 %>% 
    remove_iqr0  %>% 
    .$Variable  -> noniqr0
  
  tbl %>% 
  remove_all0 %>% 
  ungroup %>% 
  filter(!Variable %in% noniqr0)}) -> Data_IQR0_tbl_list

map(Data_IQR0_tbl_list,
    ~ check_levels(.x, "Variable")) -> Data_IQR0_list

Data_IQR0_list[["mRNA"]] %>% length # 44

map(Data_IQR0_list["mRNA"], ~ sample(.x, 100)) -> mRNA_IQR0_100

Data_IQR0_tbl_list[["mRNA"]] %>% 
  filter(Value == 0) %>% 
  group_by(Variable) %>% 
  summarise(Count = n()) %>% 
  arrange(-Count) %>% 
  ggplot(., aes(x = Count))+
  geom_histogram()

Data_IQR0_tbl_list[["mRNA"]]  %>% 
  filter(Variable %in% mRNA_IQR0_100[["mRNA"]]) %>% 
  ggplot(.,
       aes(x = Value, y = ..scaled.., fill = Variable))+
  geom_density(alpha = 0.3)+
  guides(fill = FALSE)
ggsave("Distribution/Density_mRNA_IQR0.png",
       dpi = 300, h = 3, w = 3.5)

Data_LRSD_list[["Omics1"]] %>% 
  .[. %in% Data_IQR0_list[["mRNA"]]]
# No IQR0 data in mRNA LRSD
```
![Wanna keep but need to remove for robust scaling.](Distribution/Density_mRNA_IQR0.png)

# Product
## Omics1 * Omics2
```{R}
Dualomics_Product_Scale_tbl %>% 
  filter(is.na(Value)) %>% 
  check_levels("Variable") -> Product_NA

Dualomics_Product_tbl %>% 
  filter(Variable %in% Product_NA) %>% 
  group_by(Variable) %>% 
  summarise(IQR = IQR(Value),
            Median = median(Value))
# Actually, variable removed after scale has the Median zero


Dualomics_Product_tbl %>% 
  filter(Variable %in% Product_NA) %>% 
  addmin_log10() %>% 
  group_by(Variable) %>% 
  summarise(IQR = IQR(Value),
            Median = median(Value))
# However, robustscale is applied after addmin_log10...

Dualomics_Product_tbl  %>% 
  addmin_log10 %>% 
  filter(Variable %in% Product_NA) %>% 
  ggplot(.,
       aes(x = Value, y = ..scaled.., fill = Variable))+
  geom_density(alpha = 0.3)+
  guides(fill = FALSE)
ggsave("Distribution/Density_mRNA_Scale-Inf.png",
       dpi = 300, h = 3, w = 3.5)
```
![](Distribution/Density_mRNA_Scale-Inf.png)

# Pre vs. post normalization for omics
```{R}
ggVennDiagram::ggVennDiagram(list(Pre = Dualomics_LRSD_list[[1]],
                                  Post = Dualomics_Scale_LRSD_list[[1]]))+
  scale_color_manual(values = c("2" = "darkgray",
                                "3" = "darkgray",
                                "4" = "darkgray"))+
  scale_fill_gradient(low = "#F4FAFE", high = "#4981BF")

ggVennDiagram::ggVennDiagram(list(Pre = Dualomics_LRSD_list[[2]],
                                  Post = Dualomics_Scale_LRSD_list[[2]]))+
  scale_color_manual(values = c("2" = "darkgray",
                                "3" = "darkgray",
                                "4" = "darkgray"))+
  scale_fill_gradient(low = "#F4FAFE", high = "#4981BF")
```


# Single data
## Without addmin_log10
```{R}
Clinicaldata_tbw %>%
  filter(study_id %in% study_id_Analysis) %>%
  select(study_id,
         Age_mo, intch_weight, intake_sex, premature37,
         RV, RSV, RVC_NPAseq, hMPV,
         tige, atopy_ISAC_food19, # atopy_ISAC_any
         parent_asthma,
         # intake_rsvshot, mo30_dog_0to1, # too many NA
         corticosteroids_life, prev_breathingprob) -> Clinicaldata_NN_tbw

Clinicaldata_NN_tbw %>% 
  mutate(RVC_NPAseq = if_else(is.na(RVC_NPAseq), 0, 1)) %>%
  mutate(prev_breathingprob = if_else(prev_breathingprob == "0", 0, 1)) %>% 
  mutate(intake_sex = if_else(intake_sex == "Male", 1, 0)) %>% 
  mutate_if(is.factor, as.character) %>% 
  mutate_if(is.character, as.numeric) %>% 
  gather(Variable, Value, -study_id) %>%
  mutate(Value = as.numeric(as.character(Value))) %>%
  mutate(study_id = as.factor(study_id)) %>% 
  c2f -> Clinical_tbl
```


```{R}
Dualomics_LRSD_list -> Data_LRSD_list

Data_tbl_list[["Clinical"]] %>% 
       check_levels("Variable") -> Data_LRSD_list[["Clinical"]]


Dualomics_Scale_tbl_list[[2]] %>% 
  spread(Variable, Value) %>% 
  gather(Variable, Value, -study_id) %>% 
  filter(is.na(Value)) %>% 
  check_levels("Variable")
```

```{R}
# mRNA_VST_RAW_tbl %>% 
map2(Data_tbl_list, Data_LRSD_list, function(tbl, var){
  tbl %>% 
  filter(Variable %in% var) %>% 
  mutate(Scale = "Raw") -> raw_tbl

raw_tbl %>% 
  select(-Scale) %>% 
  # addmin_log10() %>% 
  mutate(Scale = "addmin_log10") -> addmin_log10_tbl

addmin_log10_tbl %>% 
   select(-Scale) %>% 
  robustscale() %>% 
  mutate(Scale = "robustscale") -> robustscale_tbl

robustscale_tbl %>% 
   select(-Scale) %>% 
  outlier2iqr1.5() %>% 
  mutate(Scale = "outlier2iqr1.5") -> outlier2iqr1.5_tbl

outlier2iqr1.5_tbl %>% 
   select(-Scale) %>% 
  minmax01() %>% 
  mutate(Scale = "minmax01") -> minmax01_tbl

bind_rows(raw_tbl,
          addmin_log10_tbl,
          robustscale_tbl,
          outlier2iqr1.5_tbl,
          minmax01_tbl) %>% 
  mutate(Scale = fct_relevel(Scale, "Raw", "addmin_log10",
                             "robustscale", "outlier2iqr1.5", "minmax01"))}) -> Data_Density_tbl_list
```

```{R}
Data_Density_tbl_list %>% 
  imap(~ .x %>% 
         mutate(Data = .y)) %>% 
  do.call(bind_rows, .) %>% 
  filter(Scale != "addmin_log10") %>% 
  ggplot(.,
       aes(x = Value, y = ..scaled.., fill = Variable))+
  geom_density(alpha = 0.3)+
  guides(fill = FALSE)+
  facet_wrap(Data ~ Scale, scale = "free", nrow = 3)
ggsave("Distribution/Density_Single_Scale.png",
       dpi = 300,
       h = 7.5, w = 10)
```

## With addmin_log10

```{R}
# mRNA_VST_RAW_tbl %>% 
map2(Data_tbl_list, Data_LRSD_list, function(tbl, var){
  tbl %>% 
  filter(Variable %in% var) %>% 
  mutate(Scale = "Raw") -> raw_tbl

raw_tbl %>% 
  select(-Scale) %>% 
  addmin_log10() %>% 
  mutate(Scale = "addmin_log10") -> addmin_log10_tbl

addmin_log10_tbl %>% 
   select(-Scale) %>% 
  robustscale() %>% 
  mutate(Scale = "robustscale") -> robustscale_tbl

robustscale_tbl %>% 
   select(-Scale) %>% 
  outlier2iqr1.5() %>% 
  mutate(Scale = "outlier2iqr1.5") -> outlier2iqr1.5_tbl

outlier2iqr1.5_tbl %>% 
   select(-Scale) %>% 
  minmax01() %>% 
  mutate(Scale = "minmax01") -> minmax01_tbl

bind_rows(raw_tbl,
          addmin_log10_tbl,
          robustscale_tbl,
          outlier2iqr1.5_tbl,
          minmax01_tbl) %>% 
  mutate(Scale = fct_relevel(Scale, "Raw", "addmin_log10",
                             "robustscale", "outlier2iqr1.5", "minmax01"))}) -> Data_Density_AML10_tbl_list
```


```{R}
Data_Density_AML10_tbl_list %>% 
  imap(~ .x %>% 
         mutate(Data = .y)) %>% 
  do.call(bind_rows, .) %>% 
  ggplot(.,
       aes(x = Value, y = ..scaled.., fill = Variable))+
  geom_density(alpha = 0.3)+
  guides(fill = FALSE)+
  facet_wrap(Data ~ Scale, scale = "free", nrow = 3)
ggsave("Distribution/Density_Single_Scale_AML10.png",
       dpi = 300,
       h = 7.5, w = 12)
```

# Product
## Without addmin_log10
```{R}
list(mRNALipid = Dualomics_Product_tbl,
     ClinicalmRNA = ClinicalOmics_Product_tbl_list[[1]],
     ClinicalLipid = ClinicalOmics_Product_tbl_list[[2]],
     ClinicalmRNALipid = ClinicalDualomics_Product_tbl) -> Product_tbl_list
list(mRNALipid = Dualomics_Product_LRSD,
     ClinicalmRNA = ClinicalOmics_Product_LRSD_list[[1]],
     ClinicalLipid = ClinicalOmics_Product_LRSD_list[[2]],
     ClinicalmRNALipid = ClinicalDualomics_Product_LRSD) -> Product_LRSD_list

map2(Product_tbl_list, Product_LRSD_list, function(tbl, var){
  
  tbl %>% 
  filter(Variable %in% sample(var, 100)) %>% 
  mutate(Scale = "Raw") -> raw_tbl

raw_tbl %>% 
  select(-Scale) %>% 
  # addmin_log10() %>% 
  mutate(Scale = "addmin_log10") -> addmin_log10_tbl

addmin_log10_tbl %>% 
   select(-Scale) %>% 
  robustscale() %>% 
  mutate(Scale = "robustscale") -> robustscale_tbl

robustscale_tbl %>% 
   select(-Scale) %>% 
  outlier2iqr1.5() %>% 
  mutate(Scale = "outlier2iqr1.5") -> outlier2iqr1.5_tbl

outlier2iqr1.5_tbl %>% 
   select(-Scale) %>% 
  minmax01() %>% 
  mutate(Scale = "minmax01") -> minmax01_tbl

bind_rows(raw_tbl,
          addmin_log10_tbl,
          robustscale_tbl,
          outlier2iqr1.5_tbl,
          minmax01_tbl) %>% 
  mutate(Scale = fct_relevel(Scale, "Raw", "addmin_log10",
                             "robustscale", "outlier2iqr1.5", "minmax01"))}) -> Product_Density_tbl_list
```

```{R}
Product_Density_tbl_list %>% 
  imap(~ .x %>% 
         mutate(Data = .y)) %>% 
  do.call(bind_rows, .) %>% 
  filter(Scale != "addmin_log10") %>% 
  ggplot(.,
       aes(x = Value, y = ..scaled.., fill = Variable))+
  geom_density(alpha = 0.3)+
  guides(fill = FALSE)+
  facet_wrap(Data ~ Scale, scale = "free", nrow = 4)
ggsave("Distribution/Density_Product_Scale.png",
       dpi = 300,
       h = 10, w = 10)
```


## With addmin_log10
```{R}
map2(Product_tbl_list, Product_LRSD_list, function(tbl, var){
  tbl %>% 
  filter(Variable %in% sample(var, 100)) %>% 
  mutate(Scale = "Raw") -> raw_tbl

raw_tbl %>% 
  select(-Scale) %>% 
  addmin_log10() %>% 
  mutate(Scale = "addmin_log10") -> addmin_log10_tbl

addmin_log10_tbl %>% 
   select(-Scale) %>% 
  robustscale() %>% 
  mutate(Scale = "robustscale") -> robustscale_tbl

robustscale_tbl %>% 
   select(-Scale) %>% 
  outlier2iqr1.5() %>% 
  mutate(Scale = "outlier2iqr1.5") -> outlier2iqr1.5_tbl

outlier2iqr1.5_tbl %>% 
   select(-Scale) %>% 
  minmax01() %>% 
  mutate(Scale = "minmax01") -> minmax01_tbl

bind_rows(raw_tbl,
          addmin_log10_tbl,
          robustscale_tbl,
          outlier2iqr1.5_tbl,
          minmax01_tbl) %>% 
  mutate(Scale = fct_relevel(Scale, "Raw", "addmin_log10",
                             "robustscale", "outlier2iqr1.5", "minmax01"))}) -> Product_Density_AML10_tbl_list
```

```{R}
Product_Density_AML10_tbl_list %>% 
  imap(~ .x %>% 
         mutate(Data = .y)) %>% 
  do.call(bind_rows, .) %>% 
  ggplot(.,
       aes(x = Value, y = ..scaled.., fill = Variable))+
  geom_density(alpha = 0.3)+
  guides(fill = FALSE)+
  facet_wrap(Data ~ Scale, scale = "free", nrow = 4)
ggsave("Distribution/Density_Product_Scale_AML10.png",
       dpi = 300,
       h = 10, w = 12)
```

# Scale
## Dualomics
```{R}
list(mRNALipid = Dualomics_Product_tbl,
     ClinicalmRNA = ClinicalOmics_Product_tbl_list[[1]],
     ClinicalLipid = ClinicalOmics_Product_tbl_list[[2]],
     ClinicalmRNALipid = ClinicalDualomics_Product_tbl) -> Product_tbl_list
list(mRNALipid = Dualomics_Product_LRSD,
     ClinicalmRNA = ClinicalOmics_Product_LRSD_list[[1]],
     ClinicalLipid = ClinicalOmics_Product_LRSD_list[[2]],
     ClinicalmRNALipid = ClinicalDualomics_Product_LRSD) -> Product_LRSD_list

list(mRNA = mRNA_RA_RAW_tbl %>% 
            rename(Variable = Ensembl) %>% 
       filter(study_id %in% study_id_Analysis),
     
     Lipid = Lipid_Species_tbl %>% 
       filter(study_id %in% study_id_Analysis) %>%
       c2f,
     mRNALipid = Dualomics_Product_tbl) -> Dualomics_Distibution_tbl_list

list(mRNA = Dualomics_LRSD_list[[1]],
     Lipid = Dualomics_LRSD_list[[2]],
     mRNALipid = Dualomics_Product_LRSD) -> Dualomics_Distibution_LRSD_list
```

```{R}
# mRNA_VST_RAW_tbl %>% 
map2(Dualomics_Distibution_tbl_list, Dualomics_Distibution_LRSD_list, function(tbl, var){
  
  if(length(var) > 100){
  tbl %>% 
  filter(Variable %in% sample(var, 100)) %>% 
  mutate(Scale = "Raw") -> raw_tbl} else {
    tbl %>% 
  filter(Variable %in% var) %>% 
  mutate(Scale = "Raw") -> raw_tbl}

raw_tbl %>% 
  select(-Scale) %>% 
  addmin_log10() %>% 
  mutate(Scale = "addmin_log10") -> addmin_log10_tbl

addmin_log10_tbl %>% 
   select(-Scale) %>% 
  robustscale() %>% 
  mutate(Scale = "robustscale") -> robustscale_tbl

robustscale_tbl %>% 
   select(-Scale) %>% 
  outlier2iqr1.5() %>% 
  mutate(Scale = "outlier2iqr1.5") -> outlier2iqr1.5_tbl

outlier2iqr1.5_tbl %>% 
   select(-Scale) %>% 
  minmax01() %>% 
  mutate(Scale = "minmax01") -> minmax01_tbl

bind_rows(raw_tbl,
          addmin_log10_tbl,
          robustscale_tbl,
          outlier2iqr1.5_tbl,
          minmax01_tbl) %>% 
  mutate(Scale = fct_relevel(Scale, "Raw", "addmin_log10",
                             "robustscale", "outlier2iqr1.5", "minmax01"))}) -> Dualomics_Density_tbl_list
```

```{R}
Dualomics_Density_tbl_list %>% 
  imap(~ .x %>% 
         mutate(Data = .y)) %>% 
  do.call(bind_rows, .) %>% 
  ggplot(.,
       aes(x = Value, y = ..scaled.., fill = Variable))+
  geom_density(alpha = 0.3)+
  guides(fill = FALSE)+
  facet_wrap(Data ~ Scale, scale = "free", nrow = 3)
ggsave("Distribution/Density_Dualomics_Scale.png",
       dpi = 300,
       h = 7.5, w = 12)
```

## Clinical
```{R}
list(Clinical = Clinical_tbl %>%
       filter(study_id %in% study_id_Analysis) %>% 
       c2f,
    c2fClinicalmRNA = ClinicalOmics_Product_tbl_list[[1]],
     ClinicalLipid = ClinicalOmics_Product_tbl_list[[2]],
     ClinicalmRNALipid = ClinicalDualomics_Product_tbl) -> Clinical_tbl_list

list(Clinical = Clinical_tbl_list[[1]] %>% 
       check_levels("Variable"),
     ClinicalmRNA = ClinicalOmics_Product_LRSD_list[[1]],
     ClinicalLipid = ClinicalOmics_Product_LRSD_list[[2]],
     ClinicalmRNALipid = ClinicalDualomics_Product_LRSD) -> Clinical_LRSD_list
```

```{R}
# mRNA_VST_RAW_tbl %>% 
map2(Clinical_tbl_list, Clinical_LRSD_list, function(tbl, var){
  
  if(length(var) > 100){
  tbl %>% 
  filter(Variable %in% sample(var, 100)) %>% 
  mutate(Scale = "Raw") -> raw_tbl} else {
    tbl %>% 
  filter(Variable %in% var) %>% 
  mutate(Scale = "Raw") -> raw_tbl}

raw_tbl %>% 
  select(-Scale) %>% 
  # addmin_log10() %>% 
  mutate(Scale = "addmin_log10") -> addmin_log10_tbl

addmin_log10_tbl %>% 
   select(-Scale) %>% 
  robustscale() %>% 
  mutate(Scale = "robustscale") -> robustscale_tbl

robustscale_tbl %>% 
   select(-Scale) %>% 
  outlier2iqr1.5() %>% 
  mutate(Scale = "outlier2iqr1.5") -> outlier2iqr1.5_tbl

outlier2iqr1.5_tbl %>% 
   select(-Scale) %>% 
  minmax01() %>% 
  mutate(Scale = "minmax01") -> minmax01_tbl

bind_rows(raw_tbl,
          addmin_log10_tbl,
          robustscale_tbl,
          outlier2iqr1.5_tbl,
          minmax01_tbl) %>% 
  mutate(Scale = fct_relevel(Scale, "Raw", "addmin_log10",
                             "robustscale", "outlier2iqr1.5", "minmax01"))}) -> Dualomics_Density_tbl_list
```

```{R}
Dualomics_Density_tbl_list %>% 
  imap(~ .x %>% 
         mutate(Data = .y)) %>% 
  do.call(bind_rows, .) %>% 
  filter(Scale != "addmin_log10") %>% 
  ggplot(.,
       aes(x = Value, y = ..scaled.., fill = Variable))+
  geom_density(alpha = 0.3)+
  guides(fill = FALSE)+
  facet_wrap(Data ~ Scale, scale = "free", nrow = 4)
ggsave("Distribution/Density_Dualomics_Scale.png",
       dpi = 300,
       h = 7.5, w = 12)
```


# YJ-transform
## Single
```{R}
# mRNA_VST_RAW_tbl %>% 
Data_tbl_list[[1]] -> tbl

map(Data_tbl_list[c(1, 2)], function(tbl){
  tbl %>% 
    check_levels("Variable") %>% 
    sample(., 100) -> var
  
  tbl %>% 
  filter(Variable %in% var) %>% 
  mutate(Scale = "Raw") -> raw_tbl

raw_tbl %>% 
  select(-Scale) %>% 
  group_by(Variable) %>% 
  mutate(Value = bestNormalize::yeojohnson(Value)$x.t) %>% 
  ungroup %>% 
  mutate(Scale = "yeo-johnson") -> yjt_tbl

# yjt_tbl %>%
#   select(-Scale) %>%
#   mutate(Value = 1/Value) %>%
#   mutate(Scale = "inverse") -> inverse_tbl

yjt_tbl -> inverse_tbl

# inverse_tbl %>%
#    select(-Scale) %>%
#   robustscale() %>%
#   mutate(Scale = "robustscale") -> robustscale_tbl


yjt_tbl %>%
   select(-Scale) %>%
  spread(Variable, Value) %>%
  c2r("study_id") %>%
  scale %>%
  r2c("study_id") %>%
  gather(Variable, Value, -study_id) %>%
  mutate(Scale = "zscore") %>%
  c2f -> robustscale_tbl

robustscale_tbl %>% 
   select(-Scale) %>% 
  outlier2iqr1.5() %>% 
  mutate(Scale = "outlier2iqr1.5") -> outlier2iqr1.5_tbl

outlier2iqr1.5_tbl %>% 
   select(-Scale) %>% 
  minmax01() %>% 
  mutate(Scale = "minmax01") -> minmax01_tbl

bind_rows(raw_tbl,
          yjt_tbl,
          # inverse_tbl,
          robustscale_tbl,
          outlier2iqr1.5_tbl,
          minmax01_tbl) %>% 
  mutate(Scale = fct_relevel(Scale, "Raw", "yeo-johnson",
                             "inverse",
                             "robustscale",
                             "zscore",
                             "outlier2iqr1.5", "minmax01"))}) -> Data_Density_YJT_tbl_list
```

```{R}
Data_Density_YJT_tbl_list %>% 
  imap(~ .x %>% 
         mutate(Data = .y)) %>% 
  do.call(bind_rows, .) %>% 
  # filter(Scale != "addmin_log10") %>% 
  ggplot(.,
       aes(x = Value, y = ..scaled.., fill = Variable))+
  geom_density(alpha = 0.3)+
  guides(fill = FALSE)+
  facet_grid(Data ~ Scale, scale = "free")
ggsave("Distribution/Density_Single_Scale.png",
       dpi = 300,
       h = 6, w = 14)
```

```{R}
Data_Density_AML10_tbl_list %>% 
  imap(~ .x %>% 
         mutate(Data = .y)) %>% 
  do.call(bind_rows, .) %>% 
  ggplot(.,
       aes(x = Value, y = ..scaled.., fill = Variable))+
  geom_density(alpha = 0.3)+
  guides(fill = FALSE)+
  facet_wrap(Data ~ Scale, scale = "free", nrow = 3)
ggsave("Distribution/Density_Single_Scale_AML10.png",
       dpi = 300,
       h = 7.5, w = 12)
```

## Product
```{R}
map2(Product_tbl_list, Product_LRSD_list, function(tbl, var){
  
  tbl %>% 
  filter(Variable %in% sample(var, 100)) %>% 
  mutate(Scale = "Raw") -> raw_tbl

raw_tbl %>% 
  select(-Scale) %>% 
  group_by(Variable) %>% 
  mutate(Value = bestNormalize::yeojohnson(Value)$x.t) %>% 
  ungroup %>% 
  mutate(Scale = "yeo-johnson") -> addmin_log10_tbl

addmin_log10_tbl %>% 
   select(-Scale) %>% 
  robustscale() %>% 
  mutate(Scale = "robustscale") -> robustscale_tbl

robustscale_tbl %>% 
   select(-Scale) %>% 
  outlier2iqr1.5() %>% 
  mutate(Scale = "outlier2iqr1.5") -> outlier2iqr1.5_tbl

outlier2iqr1.5_tbl %>% 
   select(-Scale) %>% 
  minmax01() %>% 
  mutate(Scale = "minmax01") -> minmax01_tbl

bind_rows(raw_tbl,
          addmin_log10_tbl,
          robustscale_tbl,
          outlier2iqr1.5_tbl,
          minmax01_tbl) %>% 
  mutate(Scale = fct_relevel(Scale, "Raw", "yeo-johnson",
                             "robustscale", "outlier2iqr1.5", "minmax01"))}) -> Product_Density_YJT_tbl_list
```

```{R}
Product_Density_YJT_tbl_list %>% 
  imap(~ .x %>% 
         mutate(Data = .y)) %>% 
  do.call(bind_rows, .) %>% 
  filter(Scale != "addmin_log10") %>% 
  ggplot(.,
       aes(x = Value, y = ..scaled.., fill = Variable))+
  geom_density(alpha = 0.3)+
  guides(fill = FALSE)+
  facet_wrap(Data ~ Scale, scale = "free", nrow = 4)
ggsave("Distribution/Density_Product_Scale.png",
       dpi = 300,
       h = 10, w = 10)
```